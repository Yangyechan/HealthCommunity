<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100;0,400;0,500;0,600;0,700;1,500;1,600&family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
  <title>WebSocket Chatting</title>
</head>
<body>
<div class="container mt-5">
  <div class="row">
    <div class="col-md-6">
      <h1>WebSocket Chatting</h1>
      <button id="connect" class="btn btn-primary" onclick="loadRooms()">방 찾기</button>
      <br><br>
      <div class="input-group">
        <input type="text" id="room-name" class="form-control" placeholder="Create Room">
        <div class="input-group-append">
          <button id="create" class="btn btn-success" onclick="createRoom()">생성</button>
        </div>
      </div>
      <input type='hidden' th:value="${#authentication.principal.username}" id='currentUsername'>
    </div>
    <div class="col-md-6">
      <div class="list-group" id="room-list">
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script type="text/javascript">
  let stompClient = null;
  const pathname = window.location.pathname;
  const roomId = parseInt(pathname.split("/")[2]);
  const nickname = decodeURI(pathname.split("/")[3]);

  function getRoomName() {
    fetch(`/chat/rooms/${roomId}/name`).then((response) => {
      response.json().then((responseBody) => {
        console.log(responseBody);
        document.getElementById('room-name').innerHTML = responseBody.roomName;
      })
    });
  }

  function connect() {
    getRoomName();
    const socket = new WebSocket('ws://localhost:8080/chatting');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);
      stompClient.subscribe(`/topic/${roomId}`, function (message) {
        const jsonMessage = JSON.parse(message.body);
        if (Array.isArray(jsonMessage)) initialMessages(jsonMessage)
        else receiveMessage(jsonMessage);
      });
    });
  }

  function initialMessages(messageList) {
    for (const message of messageList)
      receiveMessage(message)
  }

  function receiveMessage(messageOutput) {
    const response = document.getElementById('response');
    const p = document.createElement('p');
    p.style.wordWrap = 'break-word';
    p.appendChild(document.createTextNode(messageOutput.sender + ": "
            + messageOutput.message + " (" + messageOutput.time + ")"));
    response.appendChild(p);
  }

  document.getElementById("message-form").addEventListener("submit", (event) => {
    event.preventDefault()
    const messageInput = document.getElementById('message');
    const message = messageInput.value
    stompClient.send("/app/chat",
            {
              "Authorization": "Bearer JWT"
            },
            JSON.stringify({
              'roomId': roomId,
              'sender': nickname,
              'message': message
            }));
    messageInput.value = null
  })
</script>
</body>
</html>
